{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏ - Arenadata Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">–†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ä–º</h1>
            <button onclick="showAddFieldModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ
            </button>
        </div>

        {% for form_type, configs in forms_info.items() %}
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">
                {% if form_type == "tech" %}üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞
                {% elif form_type == "business" %}üíº –ë–∏–∑–Ω–µ—Å —Ñ–æ—Ä–º–∞
                {% else %}üëî –§–æ—Ä–º–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è{% endif %}
            </h2>
            
            <div id="fields-{{ form_type }}" class="space-y-4">
                {% for config in configs %}
                <div class="field-container bg-gray-50 border border-gray-200 rounded-lg p-4" data-field-id="{{ config.id }}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4">
                                <div class="cursor-move text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div class="flex-1">
                                    <input type="text" 
                                           value="{{ config.field_label }}" 
                                           class="font-medium text-gray-800 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-2 py-1"
                                           onchange="updateFieldLabel({{ config.id }}, this.value)"
                                           data-field-id="{{ config.id }}">
                                </div>
                            </div>
                            <div class="mt-2 flex items-center space-x-6 text-sm">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" 
                                           id="required-{{ config.id }}"
                                           {% if config.required %}checked{% endif %} 
                                           onchange="toggleRequired({{ config.id }}, this.checked)"
                                           class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-gray-700">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" 
                                           id="active-{{ config.id }}"
                                           {% if config.is_active %}checked{% endif %} 
                                           onchange="toggleActive({{ config.id }}, this.checked)"
                                           class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-gray-700">–ê–∫—Ç–∏–≤–Ω–æ–µ</span>
                                </label>
                                <span class="text-gray-500">–¢–∏–ø: {{ config.field_type }}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="copyField({{ config.id }})" 
                                    class="text-green-600 hover:text-green-800 p-2 rounded hover:bg-green-50 transition-colors"
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteField({{ config.id }})" 
                                    class="text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50 transition-colors"
                                    title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è -->
<div id="addFieldModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ</h3>
        <form id="addFieldForm" onsubmit="handleAddField(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø —Ñ–æ—Ä–º—ã</label>
                <select name="form_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                    <option value="tech">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞</option>
                    <option value="business">–ë–∏–∑–Ω–µ—Å —Ñ–æ—Ä–º–∞</option>
                    <option value="exec">–§–æ—Ä–º–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º—è –ø–æ–ª—è (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</label>
                <input type="text" name="field_name" required class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (—Ä—É—Å—Å–∫–∏–π)</label>
                <input type="text" name="field_label" required class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –ø–æ–ª—è</label>
                <select name="field_type" class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="text">–¢–µ–∫—Å—Ç</option>
                    <option value="email">Email</option>
                    <option value="phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                    <option value="textarea">–¢–µ–∫—Å—Ç–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                    <option value="select">–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="required" class="w-4 h-4 text-blue-600 rounded">
                    <span class="text-sm font-medium text-gray-700">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</span>
                </label>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeAddFieldModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification" class="hidden fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300"></div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let draggedElement = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = "success") {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
    }`;
    notification.classList.remove("hidden");
    
    setTimeout(() => {
        notification.classList.add("hidden");
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è
function showAddFieldModal() {
    document.getElementById("addFieldModal").classList.remove("hidden");
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeAddFieldModal() {
    document.getElementById("addFieldModal").classList.add("hidden");
    document.getElementById("addFieldForm").reset();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è
function handleAddField(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch("/admin/forms/add", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification("–ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ", "success");
            closeAddFieldModal();
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—è", "error");
        }
    })
    .catch(error => {
        showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
        console.error("Error:", error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è
function updateFieldLabel(fieldId, newLabel) {
    const formData = new FormData();
    formData.append("field_label", newLabel);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≥–∞–ª–æ—á–µ–∫
    const requiredCheckbox = document.getElementById("required-" + fieldId);
    const activeCheckbox = document.getElementById("active-" + fieldId);
    
    if (requiredCheckbox) {
        formData.append("required", requiredCheckbox.checked);
    }
    if (activeCheckbox) {
        formData.append("is_active", activeCheckbox.checked);
    }
    
    fetch(`/admin/forms/${fieldId}/update`, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "success");
        } else {
            showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
        }
    })
    .catch(error => {
        showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
        console.error("Error:", error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
function toggleRequired(fieldId, isRequired) {
    const formData = new FormData();
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
    const fieldLabelInput = document.querySelector(`input[data-field-id="${fieldId}"]`);
    if (fieldLabelInput) {
        formData.append("field_label", fieldLabelInput.value);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
    formData.append("required", isRequired);
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ "–∞–∫—Ç–∏–≤–Ω–æ–µ"
    const activeCheckbox = document.getElementById("active-" + fieldId);
    if (activeCheckbox) {
        formData.append("is_active", activeCheckbox.checked);
    } else {
        formData.append("is_active", true);
    }
    
    fetch(`/admin/forms/${fieldId}/update`, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "success");
        } else {
            showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–∞–ª–æ—á–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById("required-" + fieldId).checked = !isRequired;
        }
    })
    .catch(error => {
        showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
        console.error("Error:", error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–∞–ª–æ—á–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        document.getElementById("required-" + fieldId).checked = !isRequired;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è
function toggleActive(fieldId, isActive) {
    const formData = new FormData();
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
    const fieldLabelInput = document.querySelector(`input[data-field-id="${fieldId}"]`);
    if (fieldLabelInput) {
        formData.append("field_label", fieldLabelInput.value);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ"
    const requiredCheckbox = document.getElementById("required-" + fieldId);
    if (requiredCheckbox) {
        formData.append("required", requiredCheckbox.checked);
    } else {
        formData.append("required", false);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ
    formData.append("is_active", isActive);
    
    fetch(`/admin/forms/${fieldId}/update`, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "success");
        } else {
            showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–∞–ª–æ—á–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById("active-" + fieldId).checked = !isActive;
        }
    })
    .catch(error => {
        showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
        console.error("Error:", error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–∞–ª–æ—á–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        document.getElementById("active-" + fieldId).checked = !isActive;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—è
function copyField(fieldId) {
    showNotification("–§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ", "info");
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—è
function deleteField(fieldId) {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–ª–µ?")) {
        fetch(`/admin/forms/${fieldId}/delete`, {
            method: "POST"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification("–ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ", "success");
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—è", "error");
            }
        })
        .catch(error => {
            showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
            console.error("Error:", error);
        });
    }
}

// Drag and Drop —Ñ—É–Ω–∫—Ü–∏–∏
function makeDraggable() {
    const containers = document.querySelectorAll(".field-container");
    
    containers.forEach(container => {
        container.draggable = true;
        
        container.addEventListener("dragstart", function(e) {
            draggedElement = this;
            this.style.opacity = "0.5";
        });
        
        container.addEventListener("dragend", function(e) {
            this.style.opacity = "";
        });
        
        container.addEventListener("dragover", function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(this.parentNode, e.clientY);
            if (afterElement == null) {
                this.parentNode.appendChild(draggedElement);
            } else {
                this.parentNode.insertBefore(draggedElement, afterElement);
            }
        });
        
        container.addEventListener("drop", function(e) {
            e.preventDefault();
            saveFieldOrder(this.parentNode);
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll(".field-container:not(.dragging)")];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –ø–æ–ª–µ–π
function saveFieldOrder(container) {
    const fields = container.querySelectorAll(".field-container");
    const fieldOrders = [];
    
    fields.forEach((field, index) => {
        const fieldId = field.getAttribute('data-field-id');
        fieldOrders.push(`${fieldId}:${index}`);
    });
    
    const fieldOrdersString = fieldOrders.join(',');
    
    fetch('/admin/forms/reorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `field_orders=${fieldOrdersString}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:', data.error);
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener("DOMContentLoaded", function() {
    makeDraggable();
});

</script>
{% endblock %}
