{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏ - Arenadata Admin{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">–†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ä–º</h3>
        <button onclick="showAddForm()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
            <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ
        </button>
    </div>

    {% for form_type, configs in forms_info.items() %}
    <div class="mb-8">
        <h4 class="text-md font-medium mb-3 text-gray-700">
            {% if form_type == 'tech' %}üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞
            {% elif form_type == 'business' %}üíº –ë–∏–∑–Ω–µ—Å —Ñ–æ—Ä–º–∞  
            {% else %}üëî –§–æ—Ä–º–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è{% endif %}
        </h4>
        
        <div class="space-y-3">
            {% for config in configs %}
            <div class="border border-gray-200 rounded-lg p-4 field-container" data-field-id="{{ config.id }}">
                <form method="POST" action="/admin/forms/{{ config.id }}/update" class="flex items-center justify-between">
                    <div class="flex-1 field-header">
                        <input type="text" name="field_label" value="{{ config.field_label }}" 
                            class="font-medium text-gray-900 border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1">
                        <div class="text-sm text-gray-500 mt-1 flex items-center space-x-2">
                            <span>{{ config.field_name }}</span>
                                                    </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <label class="flex items-center">
                            <input type="checkbox" name="required" {% if config.required %}checked{% endif %} 
                                class="mr-1">
                            <span class="text-sm">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="hidden" name="is_active" value="false">
                            <input type="checkbox" name="is_active" value="true" {% if config.is_active %}checked{% endif %} 
                                class="mr-1">
                            <span class="text-sm">–ê–∫—Ç–∏–≤–Ω–æ</span>
                        </label>
                        
                        <button type="submit" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-save"></i>
                        </button>
                        
                                                
                        <button type="button" onclick="deleteField({{ config.id }})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

                    <div id="addFieldModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 w-96 bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ</h3>
            <form method="POST" action="/admin/forms/add" class="mt-4 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">–¢–∏–ø —Ñ–æ—Ä–º—ã</label>
                    <select name="form_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="tech">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è</option>
                        <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                        <option value="exec">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">–°–µ–∫—Ü–∏—è</label>
                    <input type="text" name="section_name" required 
                        class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è</label>
                    <input type="text" name="field_name" required 
                        class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="problem_description">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–ª—è</label>
                    <input type="text" name="field_label" required 
                        class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">–¢–∏–ø –ø–æ–ª—è</label>
                    <select name="field_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="text">–¢–µ–∫—Å—Ç</option>
                        <option value="textarea">–ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç</option>
                        <option value="select">–í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</option>
                        <option value="radio">–†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏</option>
                        <option value="checkbox">–ß–µ–∫–±–æ–∫—Å</option>
                        <option value="email">Email</option>
                        <option value="number">–ß–∏—Å–ª–æ</option>
                        <option value="file">–§–∞–π–ª</option>
                    </select>
                </div>
                
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="required" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</span>
                    </label>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideAddForm()" 
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showAddForm() {
    document.getElementById('addFieldModal').classList.remove('hidden');
}

function hideAddForm() {
    document.getElementById('addFieldModal').classList.add('hidden');
}

function addFieldDynamically(formData) {
    fetch('/admin/forms/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showNotification('–ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—è', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
function setupAutoSave() {
    const forms = document.querySelectorAll('form[method="POST"]');
    
    forms.forEach(form => {
        const inputs = form.querySelectorAll('input[type="text"], input[type="checkbox"]');
        
        inputs.forEach(input => {
            // –î–ª—è checkbox –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—ã—Ç–∏–µ click –≤–º–µ—Å—Ç–æ change
            const eventType = input.type === 'checkbox' ? 'click' : 'change';
            input.addEventListener(eventType, function() {
                console.log('Input changed:', input.type, input.checked, input.name); // –û—Ç–ª–∞–¥–∫–∞
                // –î–ª—è checkbox —Å–æ–∑–¥–∞–µ–º FormData –≤—Ä—É—á–Ω—É—é —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å hidden –ø–æ–ª—è
                const formData = new FormData();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ input –∏–∑ —Ñ–æ—Ä–º—ã
                const allInputs = form.querySelectorAll('input');
                allInputs.forEach(inp => {
                    if (inp.type === 'checkbox') {
                        if (inp.checked) {
                            formData.append(inp.name, 'true');
                        }
                    } else if (inp.type === 'hidden') {
                        formData.append(inp.name, inp.value);
                    } else {
                        formData.append(inp.name, inp.value);
                    }
                });
                
                console.log('Sending fetch to:', form.action);
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (response.ok) {
                        showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                        const fieldId = form.closest('.field-container').dataset.fieldId;
                        const isActive = input.checked;
                        updateFieldStatus(fieldId, isActive ? 'active' : 'inactive');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        console.log('Response not ok:', response);
                    }
                })
                .catch(error => {
                    console.log('Fetch error:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                });
            });
        });
    });
}

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª–µ–π
function updateFieldStatus(fieldId, status) {
    const container = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (container) {
        if (status === 'active') {
            container.classList.remove('opacity-50');
        } else {
            container.classList.add('opacity-50');
        }
    }
}

// –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
function setupRealTimeUpdates() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        fetch('/admin/forms/status')
        .then(response => response.json())
        .then(data => {
            console.log('Status update:', data); // –û—Ç–ª–∞–¥–∫–∞
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª–µ–π –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
            Object.keys(data.fields).forEach(fieldId => {
                updateFieldStatus(fieldId, data.fields[fieldId]);
            });
        })
        .catch(error => {
            console.log('Status update error:', error);
        });
    }, 5000);
}

function deleteField(fieldId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–ª–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        fetch(`/admin/forms/${fieldId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (response.ok) {
                showNotification('–ü–æ–ª–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                location.reload();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—è', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        });
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ä–º
function makeDraggable() {
    const fieldContainers = document.querySelectorAll('.field-container');
    
    fieldContainers.forEach(container => {
        const header = container.querySelector('.field-header');
        if (header) {
            header.style.cursor = 'move';
            header.addEventListener('mousedown', startDrag);
        }
    });
}

let draggedElement = null;

function startDrag(e) {
    draggedElement = e.target.closest('.field-container');
    draggedElement.style.opacity = '0.5';
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
}

function drag(e) {
    if (!draggedElement) return;
    
    const afterElement = getDragAfterElement(e.clientY);
    const container = draggedElement.parentNode;
    
    if (afterElement == null) {
        container.appendChild(draggedElement);
    } else {
        container.insertBefore(draggedElement, afterElement);
    }
}

function stopDrag() {
    if (draggedElement) {
        draggedElement.style.opacity = '';
        updateFieldOrder();
        draggedElement = null;
    }
    
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

function getDragAfterElement(y) {
    const draggableElements = [...document.querySelectorAll('.field-container:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateFieldOrder() {
    const containers = document.querySelectorAll('.field-container');
    const orders = {};
    
    containers.forEach((container, index) => {
        const fieldId = container.dataset.fieldId;
        orders[fieldId] = index;
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/admin/forms/reorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orders)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞', 'error');
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    makeDraggable();
    setupAutoSave();
    setupRealTimeUpdates();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è drag-and-drop
    const containers = document.querySelectorAll('.field-container');
    containers.forEach(container => {
        container.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        container.addEventListener('dragleave', function(e) {
            this.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        container.addEventListener('drop', function(e) {
            this.classList.remove('border-blue-500', 'bg-blue-50');
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è
function showAddForm() {
    const formType = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø —Ñ–æ—Ä–º—ã (tech/business/exec):');
    if (!formType) return;
    
    const fieldName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—è (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º):');
    if (!fieldName) return;
    
    const fieldLabel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (–Ω–∞ —Ä—É—Å—Å–∫–æ–º):');
    if (!fieldLabel) return;
    
    const fieldType = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—è (text/email/textarea/select):', 'text');
    const required = confirm('–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ?');
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/forms/add';
    
    form.innerHTML = `
        <input type="hidden" name="form_type" value="${formType}">
        <input type="hidden" name="field_name" value="${fieldName}">
        <input type="hidden" name="field_label" value="${fieldLabel}">
        <input type="hidden" name="field_type" value="${fieldType}">
        <input type="hidden" name="required" value="${required}">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—è
function deleteField(fieldId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–ª–µ?')) {
        fetch(`/admin/forms/${fieldId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—è');
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—è
function copyField(fieldId) {
    const container = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (!container) return;
    
    const formType = container.closest('.mb-8').querySelector('h4').textContent.includes('–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è') ? 'tech' :
                     container.closest('.mb-8').querySelector('h4').textContent.includes('–ë–∏–∑–Ω–µ—Å') ? 'business' : 'exec';
    
    const fieldName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º):');
    if (!fieldName) return;
    
    const fieldLabel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è (–Ω–∞ —Ä—É—Å—Å–∫–æ–º):');
    if (!fieldLabel) return;
    
    const fieldType = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—è (text/email/textarea/select):', 'text');
    const required = confirm('–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ?');
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/forms/add';
    
    form.innerHTML = `
        <input type="hidden" name="form_type" value="${formType}">
        <input type="hidden" name="field_name" value="${fieldName}">
        <input type="hidden" name="field_label" value="${fieldLabel}">
        <input type="hidden" name="field_type" value="${fieldType}">
        <input type="hidden" name="required" value="${required}">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

</script>
{% endblock %}
