{% extends "admin/base.html" %}

{% block title %}Аналитика{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <span class="text-sm font-medium text-gray-700">Период:</span>
            <button onclick="loadAnalytics('week')" id="weekBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Неделя</button>
            <button onclick="loadAnalytics('month')" id="monthBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md">Месяц</button>
            <button onclick="loadAnalytics('year')" id="yearBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md">Год</button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Динамика отзывов</h3>
        <div style="height: 300px;">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Распределение по типам форм</h3>
        <div style="height: 300px;">
            <canvas id="formTypesChart"></canvas>
        </div>
    </div>
</div>

<script>
let trendsChart = null;
let formTypesChart = null;

function loadAnalytics(period) {
    document.querySelectorAll('[id$="Btn"]').forEach(btn => {
        btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-md';
    });
    document.getElementById(period + 'Btn').className = 'px-4 py-2 bg-blue-600 text-white rounded-md';
    
    fetch(`/api/admin/analytics/data?period=${period}&_t=${Date.now()}`)
        .then(response => response.json())
        .then(data => {
            createCharts(data);
        });
}

function createCharts(data) {
    if (trendsChart) {
        trendsChart.destroy();
    }
    if (formTypesChart) {
        formTypesChart.destroy();
    }
    
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Все отзывы',
                data: data.total,
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1
            }, {
                label: 'Критические',
                data: data.critical,
                borderColor: 'rgb(239, 68, 68)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    const formTypesCtx = document.getElementById('formTypesChart').getContext('2d');
    formTypesChart = new Chart(formTypesCtx, {
        type: 'doughnut',
        data: {
            labels: ['Технические', 'Бизнес', 'Руководители'],
            datasets: [{
                data: [data.form_types.tech, data.form_types.business, data.form_types.exec],
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics('week');
});
</script>
{% endblock %}
